import React, { useState, useEffect, useRef } from 'react';
import { 
  Calculator, 
  ArrowRightLeft, 
  History, 
  Bot, 
  Settings, 
  Trash2, 
  Send, 
  Download, 
  Coins, 
  RefreshCw,
  X,
  Menu,
  Check
} from 'lucide-react';

// --- CONFIGURATION ET DONNÉES ---

// Clé API (vide pour l'environnement d'exécution)
const apiKey = ""; 

const TRANSLATIONS = {
  fr: {
    title: "PesaNaPesa",
    tab_calc: "Calculer",
    tab_hist: "Historique",
    tab_ai: "Coach Pesa",
    lbl_amount: "Montant",
    lbl_provider: "Opérateur",
    lbl_currency: "Devise",
    btn_withdraw: "Retrait",
    btn_send: "Envoi",
    mode_normal: "Mode Normal",
    mode_reverse: "Mode Inversé",
    res_fees: "Frais",
    res_total: "Total",
    res_final: "Montant Final",
    hist_empty: "Aucun historique.",
    hist_clear: "Effacer tout",
    ai_welcome: "Mbote ! Je suis Coach Pesa. Pose-moi une question sur tes finances ou les taux à Kinshasa.",
    ai_placeholder: "Ex: Comment épargner avec un petit salaire ?",
    err_amount: "Entrez un montant valide",
    desc_normal: "Je retire/envoie ce montant.",
    desc_reverse: "Le destinataire doit recevoir ce montant.",
  },
  ln: {
    title: "PesaNaPesa",
    tab_calc: "Kotanga",
    tab_hist: "Bakala",
    tab_ai: "Conseiller",
    lbl_amount: "Motuya",
    lbl_provider: "Reseau",
    lbl_currency: "Mbongo",
    btn_withdraw: "Kobimisa",
    btn_send: "Kotinda",
    mode_normal: "Mode Normal",
    mode_reverse: "Mode Inversé",
    res_fees: "Mfutu",
    res_total: "Nionso",
    res_final: "Okozwa/Okotinda",
    hist_empty: "Eloko te.",
    hist_clear: "Longola nionso",
    ai_welcome: "Mbote! Naza Coach Pesa. Tuna ngai mituna po na mbongo na yo.",
    ai_placeholder: "Ex: Ndenge nini kobomba mbongo?",
    err_amount: "Komisa motuya ya malamu",
    desc_normal: "Nazo bimisa to kotinda motuya oyo.",
    desc_reverse: "Moto asengeli kozwa motuya oyo.",
  },
  sw: {
    title: "PesaNaPesa",
    tab_calc: "Hesabu",
    tab_hist: "Historia",
    tab_ai: "Mshauri",
    lbl_amount: "Kiasi",
    lbl_provider: "Mtandao",
    lbl_currency: "Sarafu",
    btn_withdraw: "Kutoa",
    btn_send: "Kutuma",
    mode_normal: "Kawaida",
    mode_reverse: "Kinyume",
    res_fees: "Gharama",
    res_total: "Jumla",
    res_final: "Kiasi cha Mwisho",
    hist_empty: "Hakuna historia.",
    hist_clear: "Futa zote",
    ai_welcome: "Jambo! Mimi ni Coach Pesa. Uliza swali kuhusu pesa zako.",
    ai_placeholder: "Mfano: Jinsi ya kuweka akiba?",
    err_amount: "Weka kiasi halali",
    desc_normal: "Natoa au kutuma kiasi hiki.",
    desc_reverse: "Mpokeaji lazima apate kiasi hiki.",
  }
};

// Grilles tarifaires simplifiées (USD et CDF)
// NOTE: Ces valeurs sont approximatives pour la démo.
const FEE_DATA = {
  mpesa: {
    name: "M-Pesa",
    color: "bg-green-600",
    border: "border-green-600",
    text: "text-green-600",
    bgLight: "bg-green-50",
    usd: [
      { max: 10, fee: 0.5 }, { max: 50, fee: 1 }, { max: 100, fee: 2 }, { max: 500, fee: 5 }, { max: 10000, fee: 10 }
    ],
    cdf: [
      { max: 20000, fee: 500 }, { max: 100000, fee: 1500 }, { max: 200000, fee: 3000 }, { max: 1000000, fee: 8000 }
    ]
  },
  orange: {
    name: "Orange",
    color: "bg-orange-500",
    border: "border-orange-500",
    text: "text-orange-500",
    bgLight: "bg-orange-50",
    usd: [
      { max: 10, fee: 0.4 }, { max: 50, fee: 0.9 }, { max: 100, fee: 1.8 }, { max: 500, fee: 4.5 }
    ],
    cdf: [
      { max: 20000, fee: 400 }, { max: 100000, fee: 1400 }, { max: 200000, fee: 2800 }
    ]
  },
  airtel: {
    name: "Airtel",
    color: "bg-red-600",
    border: "border-red-600",
    text: "text-red-600",
    bgLight: "bg-red-50",
    usd: [
      { max: 20, fee: 0.5 }, { max: 100, fee: 1.5 }, { max: 1000, fee: 6 }
    ],
    cdf: [
      { max: 40000, fee: 600 }, { max: 200000, fee: 2500 }
    ]
  },
  equity: {
    name: "Equity",
    color: "bg-amber-800",
    border: "border-amber-800",
    text: "text-amber-800",
    bgLight: "bg-amber-50",
    fixedPercent: 0.01 // 1% pour l'exemple
  }
};

export default function PesaNaPesaApp() {
  // --- ÉTATS GLOBAUX ---
  const [lang, setLang] = useState('fr');
  const [activeTab, setActiveTab] = useState('calc');
  const [history, setHistory] = useState([]);
  
  // --- ÉTATS CALCULATRICE ---
  const [amount, setAmount] = useState('');
  const [provider, setProvider] = useState('mpesa');
  const [currency, setCurrency] = useState('USD'); // 'USD' ou 'CDF'
  const [transType, setTransType] = useState('withdraw'); // 'withdraw' ou 'send'
  const [isReverse, setIsReverse] = useState(false); // Mode inversé
  const [result, setResult] = useState(null);

  // --- ÉTATS CHAT GEMINI ---
  const [chatHistory, setChatHistory] = useState([]);
  const [userMessage, setUserMessage] = useState('');
  const [isLoadingAI, setIsLoadingAI] = useState(false);
  const chatEndRef = useRef(null);

  const t = TRANSLATIONS[lang];

  // Charger l'historique au démarrage
  useEffect(() => {
    const savedHist = localStorage.getItem('pesaHistory');
    if (savedHist) setHistory(JSON.parse(savedHist));
  }, []);

  // Sauvegarder l'historique
  const saveToHistory = (item) => {
    const newHist = [item, ...history].slice(0, 50); // Max 50 items
    setHistory(newHist);
    localStorage.setItem('pesaHistory', JSON.stringify(newHist));
  };

  // Scroll automatique du chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatHistory]);

  // --- LOGIQUE DE CALCUL ---
  const calculate = () => {
    if (!amount || isNaN(amount)) {
      setResult(null);
      return;
    }

    const val = parseFloat(amount);
    const opData = FEE_DATA[provider];
    let fee = 0;

    // Calcul des frais (Logique simplifiée)
    if (opData.fixedPercent) {
      fee = val * opData.fixedPercent;
    } else {
      const grid = currency === 'USD' ? opData.usd : opData.cdf;
      // Si on dépasse la grille, on prend le max ou un % par défaut (ici simplifié)
      const bracket = grid.find(b => val <= b.max);
      if (bracket) fee = bracket.fee;
      else fee = grid[grid.length - 1].fee + (val * 0.01); // Fallback
    }

    // Logique Normal vs Inversé
    let finalAmount, totalPocket, feeDisplay;

    if (!isReverse) {
      // Mode Normal : Je veux retirer X -> Combien je reçois ? Ou Je veux envoyer X -> Combien je paie ?
      if (transType === 'withdraw') {
        // Retrait : On retire les frais du montant demandé ? Non, généralement on paie X pour retirer Y.
        // Simplification : Si je tape 100$ à retirer, je dois avoir 100 + frais sur mon compte, ou je reçois 100 - frais ?
        // Convention courante : "Je veux retirer 100$" => Je dois avoir 100 + frais.
        totalPocket = val + fee;
        finalAmount = val; 
      } else {
        // Envoi : J'envoie 100$, ça me coûte 100 + frais. Le destinataire reçoit 100.
        totalPocket = val + fee;
        finalAmount = val;
      }
    } else {
      // Mode Inversé : "Je veux qu'il reçoive X net" ou "Je veux avoir X en main après retrait"
      // Pour l'instant, on approxime que les frais sont basés sur le montant cible.
      // En réalité, c'est itératif, mais on simplifie : Fee(Target)
      totalPocket = val + fee;
      finalAmount = val;
    }
    
    const resObj = {
      id: Date.now(),
      date: new Date().toLocaleString(),
      amount: val,
      fee: fee,
      total: totalPocket,
      currency: currency,
      provider: FEE_DATA[provider].name,
      type: transType,
      mode: isReverse ? 'reverse' : 'normal'
    };

    setResult(resObj);
    saveToHistory(resObj);
  };

  useEffect(() => {
    calculate();
  }, [amount, provider, currency, transType, isReverse]);


  // --- LOGIQUE GEMINI API ---
  const handleSendMessage = async () => {
    if (!userMessage.trim()) return;

    const newMessage = { role: 'user', text: userMessage };
    setChatHistory(prev => [...prev, newMessage]);
    setUserMessage('');
    setIsLoadingAI(true);

    try {
      // System Prompt adapté à la langue
      const systemPrompt = `You are Coach Pesa, a friendly and knowledgeable financial assistant for a user in the Democratic Republic of Congo (DRC). 
      The user is speaking ${lang === 'ln' ? 'Lingala' : lang === 'sw' ? 'Swahili' : 'French'}. 
      Respond in the user's language mixed with local Congolese slang if appropriate.
      You know about M-Pesa, Airtel Money, Orange Money, Equity BCDC, and the exchange rate (approx 2800 FC for 1 USD).
      Give practical advice on saving money, avoiding fees, and managing daily budget in Kinshasa or Goma context.
      Keep answers concise (max 3 sentences unless asked for detail).`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userMessage }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });

      if (!response.ok) throw new Error('API Error');

      const data = await response.json();
      const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Désolé, problème de connexion.";

      setChatHistory(prev => [...prev, { role: 'model', text: botText }]);
    } catch (error) {
      setChatHistory(prev => [...prev, { role: 'model', text: "Erreur de connexion. Vérifiez votre internet." }]);
    } finally {
      setIsLoadingAI(false);
    }
  };

  // --- RENDER COMPONENTS ---

  return (
    <div className="min-h-screen bg-slate-100 font-sans text-slate-900 pb-20">
      
      {/* HEADER */}
      <header className="bg-blue-900 text-white p-4 sticky top-0 z-20 shadow-lg">
        <div className="max-w-md mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-blue-900 font-bold">
              <Coins size={18} />
            </div>
            <h1 className="font-bold text-lg tracking-tight">{t.title}</h1>
          </div>
          
          {/* Langue Selector */}
          <div className="flex bg-blue-800 rounded-lg p-1 gap-1">
            {['fr', 'ln', 'sw'].map((l) => (
              <button
                key={l}
                onClick={() => setLang(l)}
                className={`px-2 py-1 text-xs font-bold rounded ${lang === l ? 'bg-white text-blue-900' : 'text-blue-300'}`}
              >
                {l.toUpperCase()}
              </button>
            ))}
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4">

        {/* TABS */}
        {activeTab === 'calc' && (
          <div className="animate-in fade-in slide-in-from-bottom-2 duration-300">
            
            {/* TYPE & DEVISE */}
            <div className="flex gap-3 mb-4">
              <div className="flex-1 bg-white p-1 rounded-xl shadow-sm flex">
                 <button 
                  onClick={() => setTransType('withdraw')}
                  className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-1 ${transType === 'withdraw' ? 'bg-slate-800 text-white shadow' : 'text-slate-500'}`}
                >
                  <Download size={14} /> {t.btn_withdraw}
                </button>
                <button 
                  onClick={() => setTransType('send')}
                  className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-1 ${transType === 'send' ? 'bg-slate-800 text-white shadow' : 'text-slate-500'}`}
                >
                  <Send size={14} /> {t.btn_send}
                </button>
              </div>
              
              <button 
                onClick={() => setCurrency(prev => prev === 'USD' ? 'CDF' : 'USD')}
                className="px-4 bg-white rounded-xl shadow-sm font-bold text-blue-700 border border-blue-100 flex items-center gap-2"
              >
                <RefreshCw size={14} />
                {currency}
              </button>
            </div>

            {/* OPERATOR SELECTOR */}
            <div className="grid grid-cols-4 gap-2 mb-6">
              {Object.keys(FEE_DATA).map((key) => (
                <button
                  key={key}
                  onClick={() => setProvider(key)}
                  className={`flex flex-col items-center p-2 rounded-xl border-2 transition-all ${
                    provider === key 
                      ? `${FEE_DATA[key].border} ${FEE_DATA[key].bgLight} shadow-md scale-105` 
                      : 'border-transparent bg-white hover:bg-slate-50'
                  }`}
                >
                  <div className={`w-10 h-10 rounded-full ${FEE_DATA[key].color} text-white flex items-center justify-center font-bold text-sm shadow-sm mb-1`}>
                    {FEE_DATA[key].name[0]}
                  </div>
                  <span className="text-[10px] font-bold text-slate-600">{FEE_DATA[key].name}</span>
                </button>
              ))}
            </div>

            {/* MODE INVERSÉ TOGGLE */}
            <div className="flex items-center justify-between bg-blue-50 p-3 rounded-xl mb-4 border border-blue-100">
              <div className="flex items-center gap-2">
                <ArrowRightLeft size={16} className="text-blue-600" />
                <span className="text-sm font-medium text-blue-800">
                  {isReverse ? t.mode_reverse : t.mode_normal}
                </span>
              </div>
              <button 
                onClick={() => setIsReverse(!isReverse)}
                className={`w-12 h-6 rounded-full p-1 transition-colors ${isReverse ? 'bg-blue-600' : 'bg-slate-300'}`}
              >
                <div className={`w-4 h-4 bg-white rounded-full shadow transition-transform ${isReverse ? 'translate-x-6' : ''}`} />
              </button>
            </div>
            <p className="text-xs text-slate-500 text-center mb-4 italic">
              {isReverse ? t.desc_reverse : t.desc_normal}
            </p>

            {/* INPUT */}
            <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-6">
              <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">{t.lbl_amount}</label>
              <div className="flex items-baseline gap-1">
                <input 
                  type="number" 
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                  placeholder="0"
                  className="w-full text-4xl font-bold text-slate-800 outline-none bg-transparent placeholder-slate-200"
                />
                <span className="text-xl font-medium text-slate-400">{currency}</span>
              </div>
            </div>

            {/* RESULTS CARD */}
            {result && (
              <div className="bg-slate-900 text-white rounded-2xl p-6 shadow-xl relative overflow-hidden">
                <div className={`absolute top-0 right-0 w-24 h-24 opacity-10 rounded-full -translate-y-1/2 translate-x-1/3 ${FEE_DATA[provider].color}`} />
                
                <div className="flex justify-between items-center mb-6">
                  <div>
                    <p className="text-slate-400 text-xs uppercase tracking-wider">{t.res_fees}</p>
                    <p className="text-2xl font-mono text-red-400 font-bold">-{result.fee.toLocaleString()} <span className="text-sm">{currency}</span></p>
                  </div>
                  <div className="text-right">
                    <p className="text-slate-400 text-xs uppercase tracking-wider">{isReverse ? 'A envoyer/avoir' : 'Total requis'}</p>
                    <p className="text-2xl font-mono text-green-400 font-bold">{result.total.toLocaleString()} <span className="text-sm">{currency}</span></p>
                  </div>
                </div>

                <div className="bg-white/10 rounded-xl p-4 backdrop-blur-sm">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-300">{isReverse ? 'Le destinataire reçoit' : 'Vous recevez/envoyez'}</span>
                    <span className="font-bold text-xl">{result.amount.toLocaleString()} {currency}</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* HISTORIQUE TAB */}
        {activeTab === 'hist' && (
          <div className="animate-in fade-in duration-300">
            <div className="flex justify-between items-center mb-4">
              <h2 className="font-bold text-xl">{t.tab_hist}</h2>
              {history.length > 0 && (
                <button onClick={() => { setHistory([]); localStorage.removeItem('pesaHistory'); }} className="text-red-500 text-xs flex items-center gap-1 bg-red-50 px-2 py-1 rounded">
                  <Trash2 size={12} /> {t.hist_clear}
                </button>
              )}
            </div>
            
            <div className="space-y-3">
              {history.length === 0 ? (
                <div className="text-center py-10 text-slate-400 flex flex-col items-center">
                  <History size={48} className="mb-2 opacity-20" />
                  <p>{t.hist_empty}</p>
                </div>
              ) : (
                history.map((item) => (
                  <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                      <div className="flex items-center gap-2 mb-1">
                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded text-white ${FEE_DATA[item.provider.toLowerCase()]?.color || 'bg-gray-500'}`}>
                          {item.provider}
                        </span>
                        <span className="text-xs text-slate-400">{item.date.split(' ')[1]}</span>
                      </div>
                      <p className="font-bold text-lg">{item.amount.toLocaleString()} {item.currency}</p>
                    </div>
                    <div className="text-right">
                      <span className="block text-xs text-red-500 font-medium">Frais: {item.fee.toLocaleString()}</span>
                      <span className="block text-sm font-bold text-slate-700">Tot: {item.total.toLocaleString()}</span>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {/* AI COACH TAB */}
        {activeTab === 'ai' && (
          <div className="h-[calc(100vh-180px)] flex flex-col animate-in fade-in duration-300">
            <div className="flex-1 overflow-y-auto space-y-4 p-2 mb-2 scrollbar-hide">
              {/* Welcome Message */}
              <div className="flex gap-3">
                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white flex-shrink-0">
                  <Bot size={18} />
                </div>
                <div className="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-slate-100">
                  {t.ai_welcome}
                </div>
              </div>

              {/* Chat History */}
              {chatHistory.map((msg, idx) => (
                <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white flex-shrink-0 ${msg.role === 'user' ? 'bg-slate-800' : 'bg-blue-600'}`}>
                    {msg.role === 'user' ? <Settings size={18} /> : <Bot size={18} />}
                  </div>
                  <div className={`p-3 rounded-2xl shadow-sm text-sm max-w-[80%] ${msg.role === 'user' ? 'bg-slate-800 text-white rounded-tr-none' : 'bg-white text-slate-800 border border-slate-100 rounded-tl-none'}`}>
                    {msg.text}
                  </div>
                </div>
              ))}
              
              {isLoadingAI && (
                <div className="flex gap-3">
                   <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                    <Bot size={18} />
                  </div>
                  <div className="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100">
                    <div className="flex gap-1">
                      <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" />
                      <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce delay-75" />
                      <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce delay-150" />
                    </div>
                  </div>
                </div>
              )}
              <div ref={chatEndRef} />
            </div>

            {/* Input Area */}
            <div className="bg-white p-2 rounded-xl shadow border border-slate-200 flex gap-2">
              <input
                type="text"
                value={userMessage}
                onChange={(e) => setUserMessage(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                placeholder={t.ai_placeholder}
                className="flex-1 bg-transparent outline-none text-sm px-2"
              />
              <button 
                onClick={handleSendMessage}
                disabled={isLoadingAI || !userMessage.trim()}
                className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 disabled:opacity-50"
              >
                <Send size={18} />
              </button>
            </div>
          </div>
        )}

      </main>

      {/* BOTTOM NAVIGATION */}
      <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-2 pb-4 z-30">
        <div className="max-w-md mx-auto flex justify-around">
          <button 
            onClick={() => setActiveTab('calc')}
            className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activeTab === 'calc' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}
          >
            <Calculator size={20} />
            <span className="text-[10px] font-bold">{t.tab_calc}</span>
          </button>
          <button 
            onClick={() => setActiveTab('hist')}
            className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activeTab === 'hist' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}
          >
            <History size={20} />
            <span className="text-[10px] font-bold">{t.tab_hist}</span>
          </button>
          <button 
            onClick={() => setActiveTab('ai')}
            className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${activeTab === 'ai' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}
          >
            <Bot size={20} />
            <span className="text-[10px] font-bold">{t.tab_ai}</span>
          </button>
        </div>
      </nav>

    </div>
  );
}
